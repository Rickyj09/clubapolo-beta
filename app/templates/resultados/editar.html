{% extends "base_admin.html" %}
{% block title %}Resultados{% endblock %}

{% block content %}
<div class="container mt-3">
  <div class="d-flex align-items-start justify-content-between gap-3">
    <div>
      <h3 class="mb-1">Resultados - {{ torneo.nombre }}</h3>
      <div class="text-muted">
        <b>Modalidad:</b> {{ rc.modalidad }}
        &nbsp;|&nbsp;
        <b>Categoría:</b> {{ rc.categoria.nombre }}
        &nbsp;|&nbsp;
        <b>Total competidores:</b> {{ rc.total_competidores }}
      </div>
    </div>

    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary" href="{{ url_for('torneos.index') }}">
        <i class="bi bi-arrow-left"></i> Volver
      </a>
    </div>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mt-3">
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  {% if rc.acta_foto %}
    <div class="mt-3 mb-3">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <div class="fw-semibold">Acta (foto)</div>
            <a class="btn btn-sm btn-outline-primary"
               target="_blank"
               href="{{ url_for('static', filename='uploads/actas/' ~ rc.acta_foto) }}">
              <i class="bi bi-box-arrow-up-right"></i> Abrir
            </a>
          </div>

          <img src="{{ url_for('static', filename='uploads/actas/' ~ rc.acta_foto) }}"
               class="img-fluid"
               style="max-height: 520px;">
        </div>
      </div>
    </div>
  {% endif %}

  <div class="d-flex align-items-center justify-content-between mb-2">
    <div class="text-muted">
      Tip: Si la academia no existe, crea una nueva y vuelve aquí para seleccionarla.
    </div>
    <a class="btn btn-sm btn-primary"
       href="{{ url_for('academias.nueva') }}"
       target="_blank"
       rel="noopener">
      <i class="bi bi-plus-lg"></i> Nueva academia
    </a>
  </div>

  <form method="post">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    {% set filas_default = 10 %}
    {% set filas_exist = detalles|length %}
    {% set filas = (filas_exist if filas_exist > filas_default else filas_default) %}
    <input type="hidden" name="filas" value="{{ filas }}">

    <div class="table-responsive">
      <table class="table table-sm table-striped align-middle">
        <thead class="table-light">
          <tr>
            <th style="width:90px">Puesto</th>
            <th style="width:180px">Medalla</th>
            {% if rc.modalidad == 'POOMSAE' %}
              <th style="width:130px">Puntaje</th>
            {% endif %}
            <th style="width:240px">Academia</th>
            <th style="width:320px">Alumno (interno)</th>
            <th>Nombre (externo)</th>
          </tr>
        </thead>

        <tbody>
          {% for i in range(filas) %}
            {% set d = detalles[i] if i < detalles|length else None %}
            <tr>
              <td>
                <input class="form-control form-control-sm"
                       type="number"
                       name="puesto_{{ i }}"
                       value="{{ d.puesto if d else '' }}"
                       min="1">
              </td>

              <td>
                <select class="form-select form-select-sm" name="medalla_{{ i }}">
                  <option value="">--</option>
                  {% for m in medallas %}
                    <option value="{{ m.id }}" {% if d and d.medalla_id == m.id %}selected{% endif %}>
                      {{ m.nombre }}
                    </option>
                  {% endfor %}
                </select>
              </td>

              {% if rc.modalidad == 'POOMSAE' %}
              <td>
                <input class="form-control form-control-sm"
                       type="number"
                       step="0.01"
                       name="puntaje_{{ i }}"
                       value="{{ d.puntaje if d else '' }}">
              </td>
              {% endif %}

              <td>
                <select class="form-select form-select-sm" name="academia_{{ i }}">
                  <option value="">--</option>
                  {% for a in academias %}
                    <option value="{{ a.id }}" {% if d and d.academia_id == a.id %}selected{% endif %}>
                      {{ a.nombre }}
                    </option>
                  {% endfor %}
                </select>
                <div class="form-text">
                  ¿No está? <a href="{{ url_for('academias.nueva') }}" target="_blank" rel="noopener">Crear academia</a> y luego F5.
                </div>
              </td>

              <td>
                <select class="form-select form-select-sm" name="alumno_{{ i }}">
                  <option value="">--</option>
                  {% for al in alumnos %}
                    <option value="{{ al.id }}" {% if d and d.alumno_id == al.id %}selected{% endif %}>
                      {{ al.apellidos }} {{ al.nombres }}
                      {% if al.numero_identidad %} ({{ al.numero_identidad }}){% endif %}
                    </option>
                  {% endfor %}
                </select>
                <div class="form-text">Si seleccionas alumno interno, el nombre externo puede quedar vacío.</div>
              </td>

              <td>
                <input class="form-control form-control-sm"
                       name="nombre_{{ i }}"
                       value="{{ d.nombre_competidor if d else '' }}"
                       placeholder="Solo si es externo">
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="d-flex gap-2 mt-3">
      <button class="btn btn-success" type="submit">
        <i class="bi bi-save"></i> Guardar resultados
      </button>
      <a class="btn btn-secondary" href="{{ url_for('torneos.index') }}">
        Cancelar
      </a>
    </div>

  </form>
</div>
{% endblock %}