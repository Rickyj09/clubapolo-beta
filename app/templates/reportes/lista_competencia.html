{% extends "base_admin.html" %}
{% block title %}Reportes | Lista de Competencia{% endblock %}

{% block content %}
<div class="container py-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Reporte: Lista de competencia por sucursal</h2>
  </div>

  <!-- Selección de sucursal -->
  <form method="get" class="row g-2 mb-4" action="{{ url_for('reportes.lista_competencia') }}">
    <div class="col-md-6">
      <label class="form-label">Sucursal</label>
      <select name="sucursal_id" class="form-select" required>
        <option value="">-- Selecciona --</option>
        {% for s in sucursales %}
          <option value="{{ s.id }}" {% if sucursal_id == s.id %}selected{% endif %}>
            {{ s.nombre }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3 d-flex align-items-end">
      <button class="btn btn-primary w-100">Ver alumnos</button>
    </div>
  </form>

  {% if sucursal_id %}
    <div class="card shadow-sm">
      <div class="card-body">

        <div class="d-flex justify-content-between align-items-center mb-2">
          <div>
            <h5 class="mb-0">Sucursal: {{ sucursal.nombre }}</h5>
            <small class="text-muted">Marca los alumnos que asistirán</small>
          </div>
        </div>

        <form method="post" action="{{ url_for('reportes.export_lista_competencia') }}">
          <!-- ✅ CSRF -->
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

          <input type="hidden" name="sucursal_id" value="{{ sucursal_id }}">

          <div class="d-flex gap-2 mb-3">
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleAll(true)">Marcar todos</button>
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleAll(false)">Desmarcar</button>

            <button type="submit" class="btn btn-success btn-sm ms-auto">
              Descargar Excel de seleccionados
            </button>
          </div>

          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead>
                <tr>
                  <th style="width: 90px;">Seleccionado</th>
                  <th>Alumno</th>
                  <th>Identificación</th>
                  <th>Teléfono</th>
                </tr>
              </thead>
              <tbody>
                {% for a in alumnos %}
                  <tr>
                    <td>
                      <input class="form-check-input alumno-check"
                             type="checkbox"
                             name="alumno_ids"
                             value="{{ a.id }}">
                    </td>
                    <td><strong>{{ a.apellidos }} {{ a.nombres }}</strong></td>
                    <td>{{ a.numero_identidad or "" }}</td>
                    <td>{{ a.telefono or "" }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          {% if alumnos|length == 0 %}
            <div class="alert alert-warning mb-0">
              No hay alumnos activos en esta sucursal.
            </div>
          {% endif %}
        </form>

      </div>
    </div>
  {% endif %}

</div>

<script>
function toggleAll(val){
  document.querySelectorAll('.alumno-check').forEach(ch => ch.checked = val);
}
</script>
{% endblock %}